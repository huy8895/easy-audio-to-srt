name: Transcribe Audio from URL (Local Build)

on:
  workflow_dispatch:
    inputs:
      audio_url:
        description: 'URL cá»§a file audio cáº§n chuyá»ƒn'
        required: true
      output_filename:
        description: 'TÃªn file Ä‘áº§u ra (vÃ­ dá»¥: sample.mp3)'
        required: true
        default: 'audio.mp3'
      whisper_model:
        description: 'Chá»n model Whisper (tiny, small, medium, large)'
        required: true
        default: 'tiny'

jobs:
  transcribe:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ”„ Checkout source code
        uses: actions/checkout@v3

      - name: ğŸ“‚ Táº¡o thÆ° má»¥c lÃ m viá»‡c
        run: |
          echo "ğŸ“ Creating 'audio' directory..."
          mkdir -p audio

      - name: ğŸŒ Táº£i file audio tá»« URL
        run: |
          echo "ğŸŒ Downloading audio file from:"
          echo "URL: ${{ github.event.inputs.audio_url }}"
          echo "Saving as: audio/${{ github.event.inputs.output_filename }}"
          curl -L "${{ github.event.inputs.audio_url }}" -o "audio/${{ github.event.inputs.output_filename }}"
          echo "âœ… Download completed."

      - name: ğŸ› ï¸ Build Docker image tá»« Dockerfile trong repo
        run: |
          echo "ğŸ› ï¸ Building Docker image 'whisper-local'..."
          docker build -t whisper-local .
          echo "âœ… Docker image built successfully."

      - name: ğŸ§ Cháº¡y Whisper báº±ng image vá»«a build
        run: |
          echo "ğŸ§ Running Whisper with model: ${{ github.event.inputs.whisper_model }}"
          echo "ğŸ“¥ Input file: /workspace/${{ github.event.inputs.output_filename }}"
          echo "ğŸ“¤ Output format: SRT"
          docker run --rm \
            -v ${{ github.workspace }}/audio:/workspace \
            whisper-local \
            whisper "/workspace/${{ github.event.inputs.output_filename }}" \
              --language en \
              --model ${{ github.event.inputs.whisper_model }} \
              --output_format srt \
              --word_timestamps True \
              --max_words_per_line 1 \
              --output_dir /workspace
          echo "âœ… Whisper transcription completed."

      - name: â¬†ï¸ Upload SRT káº¿t quáº£
        uses: actions/upload-artifact@v2
        with:
          name: transcript
          path: audio/*.srt
